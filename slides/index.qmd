---
title: "proPower: Prospective power analyses for frequentist regression models"
author: "Dr Stefano Coretta"
institute: "University of Edinburgh"
date: "2025/01/23"
format: 
  mono-light-revealjs:
    theme: [default, "custom.scss"]
    history: false
    fig-align: center
filters:
  - tachyonsextra
execute: 
  echo: false
bibliography: references.bib
---

## Example 1: vowel duration

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(simr)
```

```{r}
#| label: eng-s
#| echo: true

library(tidyverse)

eng_s <- readRDS("data/eng_s.rds")
eng_s |> select(speaker, num_syl, voicing, v1_duration, speech_rate_c)
```

## Effect of voicing on vowel duration

```{r}
#| label: eng-s-plot

set.seed(67398)
eng_s |> 
  ggplot(aes(voicing, v1_duration)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  stat_summary(fun.data = "mean_cl_boot", colour = "darkorange") +
  facet_grid(cols = vars(num_syl)) +
  labs(
    x = "C voicing", y = "Vowel duration (ms)"
  )
```

## Prospective power analysis: overview

::: box-tip
1.  Determine Smallest Meaningful Effect Size (SMES).

2.  Run regression model on pilot or simulated data.

3.  Extend model with `simr::extend()` and set coefficient to SMES.

4.  Run power calculation with `simr::powerCurve()`.
:::

## Smallest Meaningful Effect Size

::: box-note
-   The minimum standard deviation for measurements of vowel duration is between 2 to 5 ms [@allen1978].

-   @nowak2006 finds an effect of voicing of 4.5 ms.

-   Let's set the SMES to 5 ms.
:::

## Smallest Meaningful Effect Size (ratios)

```{r}
#| label: smes

x <- seq(50, 300, by = 10)
y <- x + 5

ggplot() +
  aes(x, y/x) +
  geom_point(size = 2) +
  labs(
    x = "Vowel duration", y = "Difference ratio"
  )

```

## Run regression model

```{r}
#| label: dur-lm
#| echo: true

dur_lm <- lmer(
  log(v1_duration) ~
    voicing + num_syl + voicing:num_syl + speech_rate_c +
    (voicing | speaker),
  data = eng_s
)
```

## Extend model and set SMES

```{r}
#| label: extend
#| echo: true

dur_lm_ext <- extend(dur_lm, along = "speaker", n = 20)

fixef(dur_lm_ext)["voicingvoiced:num_sylmono"] <- 0.03
```

## Run power analysis

```{r}
#| label: power-code
#| echo: true
#| eval: false

library(simr)

dur_lm_pow <- powerCurve(
  dur_lm_ext,
  fixed("voicing:num_syl"),
  along = "speaker",
  breaks = c(50, 70, 100)
)

print(dur_lm_pow)

```

```{r}
#| label: power

dur_lm_pow <- readRDS("cache/dur_lm_pow.rds")
print(dur_lm_pow)

```

## Power curve plot

```{r}
#| label: power-curve

plot(dur_lm_pow)

```

## Example 2: accuracy

```{r}
#| label: shall

shallow_s |> 
  ggplot(aes(Relation_type, fill = as.factor(ACC))) +
  geom_bar(position = "fill")
```

## Smallest Meaningful Effect Size

::: box-note
- I have no idea...

- Say -0.2 (log-odds).
:::

## Smallest Meaningfull Effect Size

```{r}
#| label: prob-diff
x <- seq(-3, 3, by = 0.1)
a <- plogis(x)
b <- plogis(x - 0.2)
ab <- b - a

ggplot() +
  aes(plogis(x), ab) +
  geom_point() +
  labs(x = "Baseline probability", y = "Probability difference")
```

## Run regression model

```{r}
#| label: sha-lm

sha_lm <- glmer(
  ACC ~ Relation_type + (Relation_type | ID),
  family = binomial,
  data = shallow_l2
)

summary(sha_lm)
```

## Run power analysis

```{r}
#| label: sha-pow-code
#| eval: false

sha_lm_ext <- extend(sha_lm, along = "ID", n = 300)
fixef(sha_lm_ext)["Relation_typeNonConstituent"] <- -0.2

sha_lm_pow <- powerCurve(sha_lm_ext, fixed("Relation_typeNonConstituent"), along = "ID")
print(sha_lm_pow)
```

```{r}
#| label: sha-pow
#| echo: false

sha_lm_pow <- readRDS("cache/sha_lm_pow.rds")
print(sha_lm_pow)
```


## References

::: {#refs}
:::
